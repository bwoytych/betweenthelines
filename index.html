<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fantasy League — Live Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.4/tabletop.min.js"></script>
</head>
<body>
<header><h1>Fantasy Football — Live Dashboard</h1><p id="sub">Loading...</p></header>
<nav id="tabs"></nav>
<main id="main">
  <section id="standingsSection" class="panel"><h2>Standings</h2><div id="standingsWrap"></div></section>
  <section id="h2hSection" class="panel"><h2>Head-to-Head</h2><div id="h2hWrap" class="scroll"></div></section>
  <section id="bracketSection" class="panel"><h2>Playoff Bracket</h2><div id="bracketWrap"></div></section>
</main>
<footer style="text-align:center;padding:12px;font-size:13px;color:#666">Data pulled from published Google Sheet.</footer>

<script>
const PUBLISHED_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWs9EbYp9gjzjjSOfBHfoJbLNDTzaCtv2CG5u_TRvLuD0z35twSp0FCu3_3oXIxRoNPENLR6KxKMjx/pubhtml";
</script>


// List seasons to show (will try to load each sheet by name)
const SEASONS = ["2016","2017","2018","2019","2020","2021","2022","2023","2024","2025"];

// ---- Utility ----
function slug(name){ return String(name||"").toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
function isNumber(v){ return v!=='' && v!==null && !isNaN(Number(v)); }

// color palette
const palette = ["#3498db","#e74c3c","#2ecc71","#9b59b6","#f1c40f","#1abc9c","#e67e22","#34495e","#95a5a6"];

// global data caches
let sheetsData = {};
let teamsGlobal = [];
let teamClass = {}; // name -> class name
let classColor = {}; // class -> color

function ensureTeamClass(name){
  if(!name) return 'team-unknown';
  if(teamClass[name]) return teamClass[name];
  const base = 'team-'+slug(name.split(' ')[0]);
  let cand = base;
  let i=1;
  while(Object.values(teamClass).includes(cand)){ i++; cand = base + i; }
  teamClass[name] = cand;
  const color = palette[Object.keys(teamClass).length % palette.length];
  classColor[cand] = color;
  return cand;
}

// fetch all sheets via Tabletop
function loadAll(){
  document.getElementById('sub').textContent = 'Loading sheets...';
  Tabletop.init({ key: PUBLISHED_URL, simpleSheet: false, callback: processWorkbook });
}

function processWorkbook(data, tabletop){
  sheetsData = data;
  const teamSet = new Set();
  for(const s of SEASONS){
    const sheet = data[s];
    if(!sheet) continue;
    const rows = sheet;
    for(const r of rows){
      if(r['Team'] && r['Wins']){
        teamSet.add(r['Team'].trim());
      }
      if(r['Team A']) teamSet.add(r['Team A'].trim());
      if(r['Team B']) teamSet.add(r['Team B'].trim());
    }
  }
  teamsGlobal = Array.from(teamSet);
  teamsGlobal.forEach(t => ensureTeamClass(t));
  buildStyles();
  buildTabs();
  const first = SEASONS.find(s => sheetsData[s]);
  if(first) showSeason(first);
  document.getElementById('sub').textContent = 'Live — data from published sheet';
}

function buildStyles(){
  let css = document.createElement('style');
  let inner = '';
  for(const [name,cls] of Object.entries(teamClass)){
    inner += `.${cls}{background:${classColor[cls]};color:white;padding:6px;border-radius:4px;display:inline-block}
`;
  }
  css.innerHTML = inner;
  document.head.appendChild(css);
}

function buildTabs(){
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '';
  const allbtn = document.createElement('button');
  allbtn.textContent = 'All-Time';
  allbtn.className = 'tabbtn';
  allbtn.onclick = ()=> showAllTime();
  tabs.appendChild(allbtn);
  SEASONS.forEach(s => {
    const btn = document.createElement('button');
    btn.textContent = s;
    btn.className = 'tabbtn';
    btn.onclick = ()=> showSeason(s);
    if(!sheetsData[s]) btn.disabled = true;
    tabs.appendChild(btn);
  });
}

function showSeason(season){
  const data = sheetsData[season];
  if(!data){ alert('No sheet for '+season); return; }
  highlightTab(season);
  const standings = computeStandingsFromSheet(data);
  renderStandings(standings, season);
  const h2h = computeH2HFromMatches(data, standings.map(s=>s.team));
  renderH2H(h2h, standings.map(s=>s.team));
  renderBracketInteractive(standings, season, data);
}

function highlightTab(season){
  Array.from(document.querySelectorAll('.tabbtn')).forEach(b=> b.classList.remove('active'));
  const btn = Array.from(document.querySelectorAll('.tabbtn')).find(b=>b.textContent===season || (season==='All-Time' && b.textContent==='All-Time'));
  if(btn) btn.classList.add('active');
}

function computeStandingsFromSheet(rows){
  let standings = [];
  if(rows.length>0 && ('Team' in rows[0] || 'team' in rows[0])){
    const keys = Object.keys(rows[0]);
    const keyTeam = keys.find(k=>k.toLowerCase().includes('team'));
    const keyWins = keys.find(k=>k.toLowerCase().includes('win') && !k.toLowerCase().includes('percent'));
    const keyLoss = keys.find(k=>k.toLowerCase().includes('loss'));
    const keyPF = keys.find(k=>k.toLowerCase().includes('points for')||k.toLowerCase()==='pf');
    const keyPA = keys.find(k=>k.toLowerCase().includes('points against')||k.toLowerCase()==='pa');
    const keyPct = keys.find(k=>k.toLowerCase().includes('win%')||k.toLowerCase().includes('win %')||k.toLowerCase()==='pct');
    if(keyTeam && keyWins){
      for(const r of rows){
        const t = (r[keyTeam]||'').toString().trim();
        if(!t) continue;
        const wins = r[keyWins]||''; const losses = keyLoss ? (r[keyLoss]||'') : '';
        const pf = keyPF ? (r[keyPF]||'') : ''; const pa = keyPA ? (r[keyPA]||'') : '';
        const pct = keyPct ? (r[keyPct]||'') : '';
        standings.push({team:t, wins: isNumber(wins)?Number(wins):wins, losses:isNumber(losses)?Number(losses):losses, pf: isNumber(pf)?Number(pf):pf, pa:isNumber(pa)?Number(pa):pa, pct:pct});
      }
      return standings.sort((a,b)=> (b.wins||0)-(a.wins||0) || (b.pf||0)-(a.pf||0));
    }
  }
  const accum = {};
  for(const r of rows){
    const ta = r['Team A']||r['team a']||r['Team A ']||r['A']||'';
    const tb = r['Team B']||r['team b']||r['Team B ']||r['B']||'';
    const sa = r['Score A']||r['score a']||r['Score A ']||r['C']||'';
    const sb = r['Score B']||r['score b']||r['Score B ']||r['E']||'';
    if(!ta && !tb) continue;
    const A = ta.toString().trim(); const B = tb.toString().trim();
    if(!A || !B) continue;
    const aScore = isNumber(sa)?Number(sa):NaN; const bScore = isNumber(sb)?Number(sb):NaN;
    if(!(A in accum)) accum[A] = {team:A,w:0,l:0,pf:0,pa:0};
    if(!(B in accum)) accum[B] = {team:B,w:0,l:0,pf:0,pa:0};
    if(isFinite(aScore) && isFinite(bScore)){
      accum[A].pf += aScore; accum[A].pa += bScore;
      accum[B].pf += bScore; accum[B].pa += aScore;
      if(aScore > bScore){ accum[A].w +=1; accum[B].l +=1; }
      else if(aScore < bScore){ accum[B].w +=1; accum[A].l +=1; }
    }
  }
  const arr = Object.values(accum).map(x=>({team:x.team,wins:x.w,losses:x.l,pf:x.pf,pa:x.pa,pct: (x.w+x.l)>0?Math.round((x.w/(x.w+x.l))*1000)/1000:''}));
  arr.sort((a,b)=> b.wins - a.wins || b.pf - a.pf);
  return arr;
}

function computeH2HFromMatches(rows, teamOrder){
  const teams = teamOrder.slice();
  const map = {};
  teams.forEach(t=> map[t]={});
  for(const r of rows){
    const A = (r['Team A']||r['team a']||'').toString().trim();
    const B = (r['Team B']||r['team b']||'').toString().trim();
    const sa = r['Score A']||r['score a']||''; const sb = r['Score B']||r['score b']||'';
    const aScore = isNumber(sa)?Number(sa):NaN; const bScore = isNumber(sb)?Number(sb):NaN;
    if(!A || !B) continue;
    if(!(A in map)) map[A]={}; if(!(B in map)) map[B]={};
    if(!map[A][B]) map[A][B]={w:0,l:0,t:0}; if(!map[B][A]) map[B][A]={w:0,l:0,t:0};
    if(isFinite(aScore) && isFinite(bScore)){
      if(aScore > bScore){ map[A][B].w +=1; map[B][A].l +=1; }
      else if(aScore < bScore){ map[B][A].w +=1; map[A][B].l +=1; }
      else { map[A][B].t +=1; map[B][A].t +=1; }
    }
  }
  teams.forEach(a=> teams.forEach(b=> { if(!map[a][b]) map[a][b]={w:0,l:0,t:0}; }));
  return {teams, map};
}

function renderStandings(list, season){
  const wrap = document.getElementById('standingsWrap'); wrap.innerHTML='';
  const tbl = document.createElement('table');
  tbl.innerHTML = '<tr><th>Rank</th><th>Team</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>Win %</th></tr>';
  list.forEach((t,i)=>{
    const tr = document.createElement('tr');
    const cls = teamClass[t.team] || ensureTeamClass(t.team);
    tr.innerHTML = `<td>${i+1}</td><td class="${cls}">${t.team}</td><td>${t.wins || ''}</td><td>${t.losses || ''}</td><td>${t.pf || ''}</td><td>${t.pa || ''}</td><td>${t.pct || ''}</td>`;
    tbl.appendChild(tr);
  });
  wrap.appendChild(tbl);
}

function renderH2H(h2hObj, order){
  const wrap = document.getElementById('h2hWrap'); wrap.innerHTML='';
  const table = document.createElement('table');
  const thead = document.createElement('tr'); thead.innerHTML = '<th></th>' + order.map(t=>`<th>${t}</th>`).join('');
  table.appendChild(thead);
  order.forEach(r=>{
    const tr = document.createElement('tr');
    const cls = teamClass[r] || ensureTeamClass(r);
    let row = `<td class="${cls}">${r}</td>`;
    order.forEach(c=>{
      if(r===c) row += '<td>-</td>'; else {
        const d = h2hObj.map[r] && h2hObj.map[r][c] ? h2hObj.map[r][c] : {w:0,l:0,t:0};
        row += `<td>${d.w}-${d.l}${d.t?'-'+d.t:''}</td>`;
      }
    });
    tr.innerHTML = row;
    table.appendChild(tr);
  });
  wrap.appendChild(table);
}

function renderBracketInteractive(standings, season, sheetRows){
  const wrap = document.getElementById('bracketWrap'); wrap.innerHTML='';
  const year = parseInt(season,10);
  const size = year<=2021?4:8;
  if(standings.length < Math.min(size,4)){ wrap.innerHTML = '<p>Not enough teams for playoffs</p>'; return; }
  const top = standings.slice(0, size);
  const container = document.createElement('div'); container.className='bracketContainer';
  const rounds = [];
  if(size===4){
    rounds.push([{a:top[0].team,b:top[3].team, winner:null},{a:top[1].team,b:top[2].team,winner:null}]);
    rounds.push([]);
  } else {
    rounds.push([
      {a:top[0].team,b:top[7].team,winner:null},{a:top[1].team,b:top[6].team,winner:null},
      {a:top[2].team,b:top[5].team,winner:null},{a:top[3].team,b:top[4].team,winner:null}
    ]);
    rounds.push([]);
    rounds.push([]);
  }
  function renderRounds(){
    container.innerHTML='';
    rounds.forEach((rset,ri)=>{
      const col = document.createElement('div'); col.className='round';
      col.innerHTML = `<h3>${ri===0?(size===4?'Semifinals':'Quarterfinals'):ri===1?(size===4?'Final':'Semifinals'):'Final'}</h3>`;
      rset.forEach((m,mi)=>{
        const match = document.createElement('div'); match.className='match';
        const aBtn = document.createElement('button'); aBtn.textContent = m.a; aBtn.onclick = ()=> { setWinner(ri,mi,'a'); };
        const bBtn = document.createElement('button'); bBtn.textContent = m.b; bBtn.onclick = ()=> { setWinner(ri,mi,'b'); };
        match.appendChild(aBtn); match.appendChild(document.createTextNode(' vs ')); match.appendChild(bBtn);
        col.appendChild(match);
      });
      container.appendChild(col);
    });
    const finalCol = document.createElement('div'); finalCol.className='round';
    finalCol.innerHTML = `<h3>Champion</h3><div id="championSlot"></div>`;
    container.appendChild(finalCol);
    wrap.appendChild(container);
    updateChampionSlot();
  }
  function setWinner(roundIdx, matchIdx, side){
    const m = rounds[roundIdx][matchIdx];
    const winner = side==='a' ? m.a : m.b;
    m.winner = winner;
    if(roundIdx+1 < rounds.length){
      const nextIdx = Math.floor(matchIdx/2);
      if(!rounds[roundIdx+1][nextIdx]) rounds[roundIdx+1][nextIdx] = {a: winner, b: '', winner: null};
      else {
        if(!rounds[roundIdx+1][nextIdx].a) rounds[roundIdx+1][nextIdx].a = winner;
        else if(!rounds[roundIdx+1][nextIdx].b) rounds[roundIdx+1][nextIdx].b = winner;
      }
    }
    renderRounds();
  }
  function updateChampionSlot(){
    const champDiv = document.getElementById('championSlot');
    const lastRound = rounds[rounds.length-1];
    let champ = '';
    if(lastRound && lastRound.length>0 && lastRound[0].winner) champ = lastRound[0].winner;
    champDiv.textContent = champ ? champ + ' 🏆' : 'TBD';
  }
  renderRounds();
}

function showAllTime(){
  highlightTab('All-Time');
  const agg = {};
  for(const s of SEASONS){
    const rows = sheetsData[s];
    if(!rows) continue;
    const st = computeStandingsFromSheet(rows);
    st.forEach(r=>{
      if(!agg[r.team]) agg[r.team] = {team:r.team,w:0,l:0,pf:0,pa:0};
      agg[r.team].w += Number(r.wins||0); agg[r.team].l += Number(r.losses||0);
      agg[r.team].pf += Number(r.pf||0); agg[r.team].pa += Number(r.pa||0);
    });
  }
  const arr = Object.values(agg).map(x=>({team:x.team,wins:x.w,losses:x.l,pf:x.pf,pa:x.pa,pct: (x.w+x.l)>0?Math.round((x.w/(x.w+x.l))*1000)/1000:''}));
  arr.sort((a,b)=>b.wins - a.wins || b.pf - a.pf);
  renderStandings(arr, 'All-Time');
  const champRows = [];
  for(const s of SEASONS){
    const rows = sheetsData[s];
    if(!rows) continue;
    let finalCell='';
    for(const r of rows){
      for(const k of Object.keys(r)){
        if(k.toLowerCase().includes('final')){
          if(r[k] && String(r[k]).trim()!=='') finalCell = r[k];
        }
      }
    }
    let champ=''; let runner=''; let score='';
    if(finalCell){
      const text = String(finalCell);
      const m = text.match(/(.*?)[\s:\-–]+([0-9]{1,3})/);
      if(m){ champ = m[1].trim(); score = m[2]; }
      else champ = text;
    }
    champRows.push({season:s,champ:champ||'',runner:runner,score:score});
  }
  const h2hWrap = document.getElementById('h2hWrap'); h2hWrap.innerHTML='';
  const tbl = document.createElement('table');
  tbl.innerHTML = '<tr><th>Year</th><th>Champion</th><th>Runner-Up</th><th>Final Score</th></tr>' + champRows.map(r=>`<tr><td>${r.season}</td><td>${r.champ}</td><td>${r.runner}</td><td>${r.score}</td></tr>`).join('');
  h2hWrap.appendChild(tbl);
  document.getElementById('bracketWrap').innerHTML = '<p>Pick a year to view playoffs.</p>';
}

window.addEventListener('DOMContentLoaded', loadAll);
</script>
</body>
</html>
